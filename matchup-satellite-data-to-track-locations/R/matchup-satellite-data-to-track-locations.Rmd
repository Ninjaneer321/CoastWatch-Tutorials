---
title: Matchup satellite data to track locations
author: NOAA CoastWatch
date: August 2023
output:
  md_document:
    variant: gfm
---

# Matchup Satellite data to track locations

history | Modified August 2023

## Objective

This tutorial will demonstration how to extract satellite data around a set of points defined by longitude, latitude, and time coordinates, like that produced by an animal telemetry tag, and ship track, or a glider tract.

## The tutorial demonstrates the following techniques

* Importing track data in csv file to data frame
* Plotting the latitude/longitude points onto a map
* Extracting satellite data along a track from ERDDAP data server
* Plotting the satellite data onto a map

## Datasets used
**Chlorophyll a concentration, the European Space Agency's Ocean Colour Climate Change Initiative Monthly dataset v6.0**
We'll use the European Space Agency's OC-CCI product (https://climate.esa.int/en/projects/ocean-colour/) to obtain chlorophyll data. This is a merged product combining data from many ocean color sensors to create a long time series (1997-present).
**Loggerhead turtle telemetry track data**
The turtle was raised in captivity in Japan, then tagged and released on 05/04/2005 in the Central Pacific. Its tag transmitted for over 3 years and went all the way to the Southern tip of Baja California. This dataset has been subsample to reduce the data requests needed for this tutorial from over 1200 to 25.  The track data are stored in the data folder in this project folder.

## Install required packages and load libraries
```{r install,message=FALSE,warning=FALSE}

# Function to check if pkgs are installed, and install any missing pkgs
pkgTest <- function(x)
{
  if (!require(x,character.only = TRUE))
  {
    install.packages(x,dep=TRUE,repos='http://cran.us.r-project.org')
    if(!require(x,character.only = TRUE)) stop(x, " :Package not found")
  }
}


# Create list of required packages
list.of.packages <- c("rerddap", "plotdap", "parsedate", "ggplot2", "rerddapXtracto",
                       "maps", "mapdata", "RColorBrewer")

# Create list of installed packages
pkges = installed.packages()[,"Package"]

# Install and load all required pkgs
for (pk in list.of.packages) {
  pkgTest(pk)
}

```
## Import the track data into data frame

```{r tag}
# Import csv file into a data frame
turtle_df <- read.csv("../data/25317_05_subsampled.dat")

# Show 3 rows from the data frame
head(turtle_df,3)
```

## Plot the track on a map

```{r}

# Download world map
mapWorld <- map_data("world", wrap=c(0,360))

# Map turtle tracks
ggplot(turtle_df, aes(mean_lon,mean_lat)) +
  geom_path(group=1)+
  geom_point(aes(x=mean_lon[1],y=mean_lat[1]),fill="green", shape=24, size=3)+
  geom_point(aes(x=mean_lon[length(mean_lon)],y=mean_lat[length(mean_lat)]), shape=22, size=3, fill="red")+
  geom_polygon(data = mapWorld, aes(x=long, y = lat, group = group)) + 
  coord_cartesian(xlim = c(120,260),ylim = c(15,60))+
  labs(x="Longitude (deg)", y="Latitude (deg)")


```


## Extract data from a satellite dataset corresponding to points on the track

We are going to download data from an ERDDAP server using the following steps:

* Select a dataset and ERDDAP server
* Get data information using rerddap
* Extract data using rxtracto function with lat and lon of the turtle track data
* Create data frame with the satellite data and turtle tracks

### Select a dataset and get Data Info using rerddap function

Ideally we would use a daily dataset, selecting the day correspond the the track data date. However, chlorophyll measurements can have lots of missing data, primarily due to cloud cover. To reduce data gaps and improve the likelihood of data for our matchups, we can use a dataset that combines data monthly averages. 

__Let's use data from the monthly version of the OC-CCI datasets.__  
The ERDDAP URLs to the monthly version is below:    
https://oceanwatch.pifsc.noaa.gov/erddap/griddap/esa-cci-chla-monthly-v6-0  

__A note on dataset selection__  
We have preselected the dataset because we know it will work with this exercise. If you were selecting datasets on your own, you would want to check out the dataset to determine if its spatial and temporal coverages are suitable for your application. Following the link above you will find:  

The latitude range is -89.97916 to 89.97916 and the longitude range is 0.020833 to 359.97916, which covers the track latitude range of 23.72 to 41.77 and longitude range of 175.86 to 248.57.  

The time range is 1997-09-04 to 2023-03-01 (at the day of this writing), which covers the track time range of 2005-05-04 to 2008-08-16.  

You should also note the name of the variable you will be downloading. For this dataset it is "__chlor_a__"


```{r}
# Deleting all cached files
rerddap::cache_delete_all(force = TRUE)

# Set dataset ID
dataset <- 'esa-cci-chla-monthly-v6-0'

# Get data information from ERDDAP server
dataInfo <- rerddap::info(dataset, url= "https://oceanwatch.pifsc.noaa.gov/erddap")

# Display the metadata
dataInfo
```

### Extract data using rxtracto function

Define the bounding box within which to search for coordinates.  The **rxtracto** function allow you to set the size of the box used to collect data around the track points using the xlen and ylen arguments. The values for xlen and ylen are in degrees. For our example we 0.2 degrees for both arguments. Note: You can also submit vectors for xlen and ylen, as long as the are the same length as xcoord, ycoord, and tcoord.


```{r rxtracto, message=FALSE}

# Set variable name we are interested to extract from satellite data
parameter <- 'chlor_a'

# Set xlen, ylen to 0.2 degree
xlen <- 0.2 
ylen <- 0.2

xcoords <- turtle_df$mean_lon
ycoords <- turtle_df$mean_lat
tcoords <- turtle_df$date
chl_grid <- rxtracto(dataInfo, 
                  parameter=parameter, 
                  xcoord=xcoords, ycoord=ycoords, 
                  tcoord=tcoords, xlen=xlen, ylen=ylen)

```

## Check variables extracted using rxtracto

```{r}
# Check all variables extracted using rxtracto
names(chl_grid)
```

### Plot a histogram of the chlorophyll data

```{r}

chlora <- chl_grid$`mean chlor_a`

# histogram with added parameters
hist(chlora,
main="Histogram of Chlorophyll",
xlab="Chlorophyll",
breaks = 40,
col="lightblue",
freq=FALSE
)

```
## Plot a histogram of the log of the chlorophyll data

```{r}


# histogram with added parameters
hist(log(chlora),
main="Histogram of Log(Chlorophyll)",
xlab="Chlorophyll",
breaks = 30,
col="lightblue",
freq=FALSE
)

```
After the log transformatin the data seem less skewed and more normal.
The range of log chlorophyll is about -2.9 to -0.3 but most of the values are between -2.5 and -0.8.
Knowing the distribution of values can also help to set the color bar range for our map.

```{r}

```

## Plotting the results

We will use the "plotTrack" function to plot the results.  "plotTrack" is a function of the "rerddapXtracto" package designed specifically to plot the results from "rxtracto".  
  
```{r plot}

# Plot tracks with color: algae specifically designed for chlorophyll
plotTrack(chl_grid, xcoords, ycoords, tcoords, size=3, plotColor = 'algae')

```

```{r land}
mapWorld <- map_data("world", wrap=c(0,360))

ggplot(chlsta) +
  geom_point(aes(x,y,color=chl)) +
  geom_polygon(data = mapWorld, aes(x=long, y = lat, group = group)) + 
  coord_cartesian(xlim = c(120,260),ylim = c(15,60)) +
  scale_color_gradientn(colours=brewer.pal(n = 8, name = "YlGn")) +
  labs(x="", y="")


```

## Animating the track

Make a cumulative animation of the track. This will take a minute to run. It creates an animated gif that will display in the Rstudio viewer window once the encoding to gif is done.

```{r track}
library(plotdap)
plotTrack(swchl, xcoord, ycoord, tcoord, plotColor = 'algae',
                    animate = TRUE, cumulative = TRUE)
```
     
     
 